var Adv=function(){var n,S=this,A=new AdvHashmap,p=new AdvRequests,v={};this.ptsHandlerComponent=new PtsHandlerComponent,this.callAdServerRoundTripTime=0;var t={};function f(e){try{var t=JSON.parse(e);if(t.STARTdata.triplet!==serviceManager.getCurrentChannel().getChannelToString())return void logManager.warning("startEventProcess - event triplet ("+t.STARTdata.triplet+") not corresponding to current channel's triplet ("+serviceManager.getCurrentChannel().getChannelToString()+")");A.getValue(t.STARTdata.break_code)?r(e):S.getConfiguration().CALL_ADSERVER_FALLBACK_ON_STARTEVENT&&"spot"===S.getConfiguration().AD_SUBSTITUTION_METHOD?(logManager.log("startEventProcess - break_code not found in dictionary: triggering callAdServer."),a(e,function(){r(e)})):logManager.warning("startEventProcess - break code not found in dictionary.")}catch(e){logManager.error("startEventProcess - error: "+e.message)}}function a(e,r){try{if(null==featuresManager.getFeature("linearAdTracking")||!0!==featuresManager.getFeature("linearAdTracking"))return void logManager.warning("callAdServerProcess - linearAdTracking feature is not true");if(consent&&(null==consent.getModel()||!0!==consent.getModelConsents().TRACKING.consentStatus))return void logManager.warning("callAdServerProcess - user consent not given to TRACKING");var o=JSON.parse(e);if(0!==Object.keys(v).length&&"break"===S.getConfiguration().AD_SUBSTITUTION_METHOD)return void logManager.warning("callAdServerProcess - Discarding Event: Break tracking already in progress.");if(o.LOADdata.triplet!==serviceManager.getCurrentChannel().getChannelToString())return void logManager.warning("callAdServerProcess - event triplet ("+o.LOADdata.triplet+") not corresponding to current channel's triplet ("+serviceManager.getCurrentChannel().getChannelToString()+")");if(A.isAdvIDExists(o.LOADdata.break_code))return void logManager.warning("callAdServerProcess - break code already loaded");if(A.initialize(o.LOADdata.break_code),A.setStatus(o.LOADdata.break_code,A.lstStatus.LOADING),consent&&null==consent.getModel())return void logManager.warning("callAdServerProcess - getWizadsData() the tvId is not retrived yet");o.LOADdata.channel&&(o.LOADdata.channel=o.LOADdata.channel.toUpperCase());var t=consent?consent.getModel().tvId:"",a=t+(new Date).getTime(),n=o.LOADdata.dai_version,i=o.LOADdata.channel,s=o.LOADdata.break_code,c=o.LOADdata.bday||"",g=o.LOADdata.break_duration,d=core.getPlatform().brand.toLowerCase().trim(),l=S.getConfiguration().AD_SUBSTITUTION_METHOD,u=S.getConfiguration().ADSERVER_URL;u+="?dai_version="+n+"&transaction_id="+a+"&response_type="+l+"&channel="+i+"&break_code="+s+"&break_day="+c+"&break_duration="+g+"&advertising_id="+t+"&platform="+d+"&context=live&current_spot=0";var T=Date.now();p.getWizadsData(u,function(e){var t,a;function n(){logManager.log("breakTracking - Processing break["+t.LOADdata.break_code+"] - Sequence["+a+"] started");var e={LOADdata:t.LOADdata,STARTdata:{break_code:t.STARTdata.break_code,sequence:a,triplet:t.STARTdata.triplet,duration:v.spots[a].duration,pts:0}};null!=v.spots[a+1]&&window.setTimeout(n,v.spots[a].duration+S.getConfiguration().BLACK_FRAMES_DURATION_AFTER_SPOT),f(JSON.stringify(e)),a++}S.callAdServerRoundTripTime=Date.now()-T,0!==Object.keys(e).length?(function(e,t){try{v={},logManager.log("createDictionary() - Creating dictionary");var a=t.Ads;if(0<a.length){v.id=e,logManager.log("createDictionary() - dictionary.id: "+v.id),v.spots=[];for(var n=0;n<a.length;n++)v.spots[parseInt(a[n].Sequence)]=function(e){var t;return(t=function(e){try{var t={},a=e.InLine.Creatives[0].Linear.Duration;t.duration=1e3*+a,t.tracking={};var n=e.InLine.Creatives[0].Linear.TrackingEvents;t.tracking.impression=e.InLine.Impressions[0].Data.trim();for(var r=0;r<n.length;r++)switch(n[r].Event){case"firstQuartile":t.tracking.firstQuartile=n[r].Data.trim();break;case"midpoint":t.tracking.midpoint=n[r].Data.trim();break;case"thirdQuartile":t.tracking.thirdQuartile=n[r].Data.trim();break;case"complete":t.tracking.complete=n[r].Data.trim()}var o=e.InLine.Creatives[0].Linear.MediaFiles[0].Data.trim();return t.media_file_url=o,t.media_file_type="addressed",-1!==o.indexOf("broadcasted")&&(t.media_file_type="broadcasted"),t}catch(e){logManager.error("createTrackingItemsForDictionary: "+e)}}(e)).companionAd=function(e){try{var t={};return t=null!=e.InLine.Creatives[0].CompanionAds?e.InLine.Creatives[0].CompanionAds:t}catch(e){logManager.error("createCompanionAdForDictionary: "+e)}}(e),t}(a[n]),logManager.log("createDictionary() - dictionary.spots["+parseInt(a[n].Sequence)+"] tracking items loaded")}else logManager.log("createDictionary() - no Ads found in VAST file.")}catch(e){logManager.error("createDictionary: "+e)}}(o.LOADdata.break_code,e),A.setValue(o.LOADdata.break_code,v,A.type.STREAMEVENT),A.setStatus(o.LOADdata.break_code,A.lstStatus.LOADED),null!=r&&r(),"break"===S.getConfiguration().AD_SUBSTITUTION_METHOD&&(a=(t=o).STARTdata.sequence,featuresManager.getFeature("PTSMethod")?(logManager.warning("breakTracking - Waiting first START PTS time in order to start tracking queue."),S.ptsHandlerComponent.ptsStartEventTimeCheck(t,n)):(logManager.warning("breakTracking - no PTS or Delay method for this client in the feature file. Queuing starts immediately."),n()))):logManager.log("callAdServerProcess - VAST file is an empty object.")},function(e){M(o.LOADdata.break_code),logManager.error("getWizadsData() KO Response")})}catch(e){logManager.error("callAdServerProcess - error: "+e.message)}}function r(e){var t=JSON.parse(e),a=A.getValue(t.STARTdata.break_code);if(a.status===A.lstStatus.LOADED||a.status===A.lstStatus.STARTED)if(A.setStatus(t.STARTdata.break_code,A.lstStatus.STARTED),v.spots.hasOwnProperty(t.STARTdata.sequence))if(logManager.log("startEventProcessPostValidation - Event payload: "+e),t.STARTdata.duration===v.spots[t.STARTdata.sequence].duration)switch(S.getConfiguration().AD_SUBSTITUTION_METHOD){case"spot":featuresManager.getFeature("PTSMethod")?S.ptsHandlerComponent.ptsStartEventTimeCheck(t,o):logManager.warning("startEventProcess - no PTS or Delay method for this client in the feature file.");break;case"break":o(t);break;default:logManager.warning('startEventProcess - no "break" or "spot" mode enabled.')}else logManager.warning("startEventProcess - spot duration in Stream Event payload ("+t.STARTdata.duration+") not matching the VAST duration for this spot ("+v.spots[t.STARTdata.sequence].duration+")");else logManager.warning("startEventProcess - sequence not found: "+t.STARTdata.sequence);else logManager.warning("startEventProcess - incorrect status : "+a.status)}function o(e){A.getValue(e.STARTdata.break_code)?!consent||null!=consent.getModel()&&!0===consent.getModelConsents().TRACKING.consentStatus?featuresManager.getFeature("linearAdTracking")&&!0===featuresManager.getFeature("linearAdTracking")&&function(t){try{var e,a;null!=v&&0<Object.keys(v).length&&null!=t.STARTdata.sequence&&v.id===t.STARTdata.break_code?(e=v.spots[t.STARTdata.sequence].duration/4,a=0,i(v.spots[t.STARTdata.sequence].tracking.impression,"impression",t.STARTdata.sequence),n=window.setInterval(function(){switch(++a){case 1:i(v.spots[t.STARTdata.sequence].tracking.firstQuartile,"firstQuartile",t.STARTdata.sequence);break;case 2:i(v.spots[t.STARTdata.sequence].tracking.midpoint,"midpoint",t.STARTdata.sequence);break;case 3:i(v.spots[t.STARTdata.sequence].tracking.thirdQuartile,"thirdQuartile",t.STARTdata.sequence);break;case 4:!function(e){i(v.spots[e.STARTdata.sequence].tracking.complete,"complete",e.STARTdata.sequence),n&&window.clearInterval(n);s(e.STARTdata.break_code,e.STARTdata.sequence),logManager.log("Adv pixel tracking schedulation ended.")}(t)}},e)):logManager.warning("scheduleSpotTracking - empty dictionary")}catch(e){logManager.error("scheduleSpotTracking: "+e),s(t.STARTdata.break_code,t.STARTdata.sequence)}}(e):(logManager.warning("startEventCoreProcess - user consent not given to TRACKING"),s(e.STARTdata.break_code,e.STARTdata.sequence)):logManager.warning("startEventCoreProcess - break code not found")}function i(e,t,a){if(trace&&trace.injectTrackingPixel(e),S.getConfiguration().VISIBLE_AD_TRACKING)switch(t){case"impression":case"complete":!function(e,t,a){var n=$(".trackingPopupContainer"),r="5%";1<=n.length&&(r="50%");var o=$("<div class='trackingPopupContainer' style='position:absolute; top:"+r+"; left:65px; width: 50%; padding:5px; z-index: 9999; background-color:rgba(255,255,255,0.7); color:#000; border:1px solid #000; word-break: break-all;'><b>Sequence: </b>"+a+"<br /><b>Tracking: </b>"+$.camelCase(e)+"<br /><b>URL: </b> "+escapeXml(t)+"</div>");$(".tvium-container").append(o),window.setTimeout(function(){o.remove()},3e3)}(t,e,a)}logManager.log("Sequence["+a+"] - "+t+" pixel image loaded - "+escapeXml(e))}function s(e,t){v.spots.hasOwnProperty(t)?(delete v.spots[t],0===Object.keys(v.spots).length&&(M(e),A.clearLst(),v={},logManager.log("All spots of the break has been removed!"))):logManager.warning("removeSpotFromDictionary - "+t+" not found")}function M(e){A.isAdvIDExists(e)?(A.setStatus(e,A.lstStatus.STOP),A.deleteAdv(e)):logManager.warning("clearAdv - event ID not found")}return this.getConfiguration=function(){return t},{configure:function(e){t=e},onFiredAdv:function(e){"spot"===S.getConfiguration().AD_SUBSTITUTION_METHOD?f(e.text):"break"===S.getConfiguration().AD_SUBSTITUTION_METHOD?a(e.text,null):logManager.warning("onAdEventReceived - No SpotMode or BreakMode set in the configuration.")},callAdServerProcess:a,startProcess:f}},AdvHashmap=function(){var n={status:null,dictionary:null},a=null,r={LOADING:"LOADING",LOADED:"LOADED",STARTING:"STARTING",STARTED:"STARTED",STOP:"STOP"};function o(e){return e in n}return{deleteAdv:function(e){delete n[e],logManager.log("deleteAdv -  Adv Deleted!")},initialize:function(e){n[e.toString()]={status:null,dictionary:null}},setValue:function(e,t,a){o(e)||(n[e]={}),n[e].dictionary=t,n[e].type=a},getValue:function(e){return o(e)?n[e]:null},setStatus:function(e,t){o(e)?(n[e].status=t)==r.STARTING?a=e:t==r.STOP&&(a=null,logManager.log("Status: "+t)):logManager.warning("Adv ID not found: "+e)},isAdvIDExists:o,isAdvAlreadyStarted:function(){return null!=a},lstStatus:r,type:{STREAMEVENT:"STREAMEVENT"},clearLst:function(){n={},a=null},lstAdvIsEmpty:function(){return 0==Object.keys(n).length||0==Object.keys(n).length}}},PtsHandlerComponent=function(){this.ptsStartEventTimeCheck=function(a,n){null!=mediaSyncManager.getCurrentTime()?(logManager.log("ptsStartEventTimeCheck - currentTime: "+mediaSyncManager.getCurrentTime()+" - PTS check starting in "+(a.STARTdata.pts-mediaSyncManager.getCurrentTime()-adv.getConfiguration().PTS_CHECK_START_TIME-featuresManager.getFeature("ptsSpotModeSwitchInDurationFineTuning"))+"Ms."),setTimeout(function(){var t=setInterval(function(){var e=mediaSyncManager.getCurrentTime();logManager.log("MediaSynchroniser.currentTime = "+e+" - Event PTS time = "+a.STARTdata.pts+" - Time difference = "+(Math.abs(a.STARTdata.pts-e)-featuresManager.getFeature("ptsSpotModeSwitchInDurationFineTuning"))),a.STARTdata.pts-e-featuresManager.getFeature("ptsSpotModeSwitchInDurationFineTuning")+adv.getConfiguration().PTS_CHECK_TOLERANCE<0&&(logManager.warning("ptsStartEventTimeCheck - payload PTS already expired. We can't go back in time Morty!"),window.clearInterval(t)),Math.abs(a.STARTdata.pts-e-featuresManager.getFeature("ptsSpotModeSwitchInDurationFineTuning"))<=adv.getConfiguration().PTS_CHECK_TOLERANCE&&(n(a),window.clearInterval(t))},adv.getConfiguration().PTS_CHECK_INTERVAL_TIME+featuresManager.getFeature("PTSCheckIntervalFineTuning"))},a.STARTdata.pts-mediaSyncManager.getCurrentTime()-adv.getConfiguration().PTS_CHECK_START_TIME-featuresManager.getFeature("ptsSpotModeSwitchInDurationFineTuning"))):logManager.error("ptsStartEventTimeCheck - MediaSynchroniser not available")}},AdvRequests=function(){var s=0;this.getWizadsData=function(n,r,o){var i="AdvRequests.getWizadsData()",e=n;logManager.log(i+" CALLED - url: "+n),$.ajax({type:"GET",contentType:"application/json",dataType:"json",url:e,timeout:adv.getConfiguration().GET_WIZADS_TIMEOUT,success:function(e,t,a){logManager.log(i+" - Response : OK"),r(e)},error:function(e,t,a){logManager.error(i+" - Error : "+JSON.stringify(a,null,4)),"timeout"===t&&s<1&&(s++,self.getWizadsData(n,r,o)),o()}})}};